name: CI Symfony

on:
  push:
    branches: [ "master", "main" ]
  pull_request:

jobs:

  lint:
    name: Linting
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v6

      - name: Setup de PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

      - name: Installation d√©pendances
        run: composer install --no-interaction --prefer-dist

      - name: PHP CodeSniffer
        run: vendor/bin/phpcs

      - name: PHPStan
        run: vendor/bin/phpstan analyse -c phpstan.dist.neon

  health-test:
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v6

        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

        run: composer install --no-interaction --prefer-dist

        run: |
          php -S 127.0.0.1:8000 -t public &
          sleep 5

        run: curl -f http://127.0.0.1:8000

  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: health-test

    steps:
      - uses: actions/checkout@v6

      - name: Setup de PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

        run: composer install --no-interaction --prefer-dist

        run: vendor/bin/phpunit --testsuite Unit

        run: vendor/bin/phpunit --testsuite Integration

  e2e:
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - uses: actions/checkout@v6

      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

      - uses: actions/setup-node@v6
        with:
          node-version: '20'

      - run: npm ci

      - run: |
          php -S 127.0.0.1:8000 -t public &
          sleep 3

      - run: npx cypress run

  notify:
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, healthcheck, tests, e2e]

    steps:
      - run: echo "CI finished"